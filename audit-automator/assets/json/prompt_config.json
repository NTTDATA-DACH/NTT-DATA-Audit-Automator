{
  "system_message": "You are a very experienced BSI security auditor with an in depth knowledge of BSI Standards 200-1, 200-2 and 200-3 analyzing the correctness of the customer's reference documents for an audit.\n\nRules:\n1. Imperative: Based *only* on the attached customer documentation files or provided context, answer the following questions!\n2. Imperative: If the attached documents are insufficient to answer a question, state that clearly in your answer (e.g., \"Cannot be determined from the provided documents.\").\n3. While you try to answer the questions, check if the documents contain deviations from BSI Grundschutz.\n4. Generate a finding for each deviation.\n5. Categorize the finding as 'AG' (Minor Deviation), 'AS' (Major Deviation, very seldom, use carefully!), 'E' (Recommendation).\n6. Provide evidence and a reference to the specific document that caused the finding in the finding's description.\n**Important:** The categorization should be relaxed. Small deviation are an E, Only when its more than a few mistakes, you should use AG! If the BSI Standards recommend something, it is only a recommendation, not a strict requirement! Like having 4 instead of 3 Schutzbedarfskategorien! And AS only if the deviation is so grave, that the ISMS is not functioning properly!\nIf you evaluate documents to answer questions, the answer should be 'yes' when there is no AG or AS! \n\nYour response MUST be a single JSON object that strictly adheres to the provided JSON schema.\n6. You answer in professional german, you are precise and on the point with ecamples and reasons for your decision.",
  "stages": {
    "ETL": {
      "classify_documents": {
        "prompt": "You are an expert BSI (German Federal Office for Information Security) audit assistant. Your task is to analyze a list of document filenames and classify each one into a single, most appropriate category from a predefined list. The filenames often contain clues like \"A.1\", \"A.4\", \"Netzplan\", \"Sicherheitsleitlinie\", \"Auditbericht\", etc.\n\n**Predefined Categories:**\n- \"Sicherheitsleitlinie\": The main, high-level security policy document.\n- \"Organisations-Richtlinie\": Other policies, guidelines, or organizational rules.\n- \"Informationsverbund\": Documents describing the scope and boundary of the information network.\n- \"Netzplan\": Network diagrams or topology plans.\n- \"Strukturanalyse\": The core structural analysis document (often A.1).\n- \"Schutzbedarfsfeststellung\": Protection needs assessment document (often A.2).\n- \"Modellierung\": The IT Grundschutz modeling document (often A.3).\n- \"Grundschutz-Check\": The implementation check of controls (often A.4).\n- \"Risikoanalyse\": Risk analysis documents (often A.5).\n- \"Realisierungsplan\": The risk treatment or implementation plan (often A.6).\n- \"Dienstleister-Liste\": Lists of external service providers.\n- \"Vorheriger-Auditbericht\": A previous, complete audit report.\n- \"Sonstiges\": Any other document that does not fit the above categories.\n\nAnalyze the following list of filenames and return a structured JSON response mapping each filename to its category.\n\n**Filenames to Classify:**\n---\n{filenames_json}\n---",
        "schema_path": "assets/schemas/etl_classify_documents_schema.json"
      }
    },
    "Chapter-3-Ground-Truth": {
      "extract_zielobjekte": {
        "prompt": "You are an expert data extraction system. From the attached Strukturanalyse document (A.1), extract a complete list of all Zielobjekte (target objects). For each Zielobjekt, provide its unique ID (Kürzel) and its full descriptive name (Name). In the header on the first page, there is a Zielobjekt 'Informationsverbund' and a Kürzel for it as well, make sure to add that to the list as first entry! Also extract the name of the Informationsverbund itself (not the Kürzel, but the actual name/title of the entire information network).",
        "schema_path": "assets/schemas/stage_3_gt_zielobjekte_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "extract_baustein_mappings": {
        "prompt": "You are an expert data extraction system. From the attached Modellierung document (A.3), analyze which Zielobjekt (target object) each Baustein (building block) is applied to. Return a list of mappings, where each mapping contains the Baustein ID and the Kürzel (unique ID) of the Zielobjekt it's mapped to. Ignore Bausteine from layers ISMS, ORP, CON, OPS, and DER.",
        "schema_path": "assets/schemas/stage_3_gt_baustein_mappings_schema.json"
      }
    },
    "Chapter-1": {
      "informationsverbund": {
        "prompt": "Your task is to analyze the provided context, which describes the scope of an information security network (Informationsverbund), and extract two key pieces of information:\n1.  **kurzbezeichnung**: A short, official name or title for the Informationsverbund.\n2.  **kurzbeschreibung**: A concise paragraph summarizing the scope, including key business processes, applications, and physical locations. This should also serve as the main description for the 'Geltungsbereich'.\n\nIf the provided context is insufficient or empty, state that the scope could not be fully determined from the documents and must be clarified manually.",
        "schema_path": "assets/schemas/stage_1_4_informationsverbund_schema.json"
      }
    },
    "Chapter-3": {
      "generic_question": {
        "prompt": "The questions to answer are:\n{questions}"
      },
      "targeted_question": {
        "prompt": "You are a BSI auditor. Based *only* on the following structured JSON data and, if provided, the attached context document(s), answer the question: {question}\n\n**JSON Data:**\n---\n{json_data}\n---"
      },
      "generic_summary": {
        "prompt": "You are a BSI security auditor providing a final verdict on the {summary_topic}.\nBased on the summary of findings from the previous sections provided below, provide a summary verdict (\"Votum\").\n\n**Summary of Previous Findings:**\n---\n{previous_findings}\n---"
      },
      "refine_layout_parser_group": {
        "prompt": "You are an expert system for structuring BSI Grundschutz data. Your input is a JSON object containing a list of layout blocks from a Document AI Layout Parser. These blocks all belong to a single Zielobjekt (target object). Your task is to analyze these blocks and assemble them into a final, structured list of requirements according to the provided schema. The goal is to find rows or groups of text that represent a single security requirement and extract its ID, title, status, explanation, and last-checked date.\n\n**Input Document AI Layout Blocks:**\n---\n{zielobjekt_blocks_json}\n---",
        "schema_path": "assets/schemas/stage_3_6_1_extract_check_data_schema.json"
      },
      "aktualitaetDerReferenzdokumente": {
        "schema_path": "assets/schemas/stage_3_1_aktualitaet_schema.json",
        "prompt": "Ignore the missing A.4 GRundschutz-Check.",
        "source_categories": ["Sicherheitsleitlinie", "Organisations-Richtlinie", "Netzplan", "Strukturanalyse", "Dienstleister-Liste", "Realisierungsplan", "Risikoanalyse", "Schutzbedarfsfeststellung", "Modellierung"]
      },
      "sicherheitsleitlinieUndRichtlinienInA0": {
        "schema_path": "assets/schemas/stage_3_2_sicherheitsleitlinie_schema.json",
        "source_categories": ["Sicherheitsleitlinie", "Organisations-Richtlinie"]
      },
      "definitionDesInformationsverbundes": {
        "schema_path": "assets/schemas/stage_3_3_1_informationsverbund_schema.json",
        "source_categories": ["Informationsverbund", "Strukturanalyse"]
      },
      "bereinigterNetzplan": {
        "schema_path": "assets/schemas/stage_3_3_2_netzplan_schema.json",
        "source_categories": ["Netzplan", "Strukturanalyse"]
      },
      "listeDerGeschaeftsprozesse": {
        "schema_path": "assets/schemas/stage_3_3_3_geschaeftsprozesse_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "listeDerAnwendungen": {
        "schema_path": "assets/schemas/generic_1_question_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "listeDerItSysteme": {
        "schema_path": "assets/schemas/generic_1_question_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "listeDerRaeumeGebaeudeStandorte": {
        "schema_path": "assets/schemas/generic_1_question_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "listeDerKommunikationsverbindungen": {
        "schema_path": "assets/schemas/generic_1_question_schema.json",
        "source_categories": ["Strukturanalyse"]
      },
      "listeDerDienstleister": {
        "schema_path": "assets/schemas/generic_1_question_schema.json",
        "source_categories": ["Strukturanalyse", "Dienstleister-Liste"]
      },
      "stichprobenDokuStrukturanalyse": {
        "schema_path": "assets/schemas/generic_0_question_schema.json",
        "source_categories": ["Strukturanalyse"]
       },
      "stichprobenDokuSchutzbedarf": {
         "schema_path": "assets/schemas/generic_0_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },      
      "ergebnisDerStrukturanalyse": {
        "type": "summary",
        "schema_path": "assets/schemas/stage_3_summary_schema.json"
      },
      "definitionDerSchutzbedarfskategorien": {
        "schema_path": "assets/schemas/stage_3_4_1_schutzbedarfskategorien_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "schutzbedarfGeschaeftsprozesse": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "schutzbedarfAnwendungen": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "schutzbedarfItSysteme": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "schutzbedarfRaeume": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "schutzbedarfKommunikationsverbindungen": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Schutzbedarfsfeststellung"]
      },
      "ergebnisDerSchutzbedarfsfeststellung": {
        "type": "summary",
        "schema_path": "assets/schemas/stage_3_summary_schema.json"
      },
      "modellierungsdetails": {
        "schema_path": "assets/schemas/stage_3_5_1_modellierungsdetails_schema.json",
        "prompt": "The questions to answer are:\n{questions}\n\nAdditionally, review the attached Modellierung document against the authoritative list of Zielobjekte provided below. Does the Modellierung correctly account for all Zielobjekte from this list that are relevant?\n\n**Authoritative List of Zielobjekte (Ground Truth):**\n---\n{zielobjekte_json}\n---",
        "source_categories": ["Modellierung"]
      },
      "ergebnisDerModellierung": {
        "type": "summary",
        "schema_path": "assets/schemas/stage_3_summary_schema.json"
      },
      "detailsZumItGrundschutzCheck": {
        "type": "custom_logic"
      },
      "benutzerdefinierteBausteine": {
        "schema_path": "assets/schemas/generic_2_question_schema.json",
        "source_categories": ["Modellierung"]
      },
      "ergebnisItGrundschutzCheck": {
        "type": "summary",
        "schema_path": "assets/schemas/stage_3_summary_schema.json"
      },
      "risikoanalyse": {
        "schema_path": "assets/schemas/stage_3_7_risikoanalyse_schema.json",
        "source_categories": ["Risikoanalyse"]
      },
      "questions": {
        "entbehrlich": "Sind die Begründungen für 'entbehrlich' plausibel? BSI-Regel: 1. Wenn eine alternative Schutzmaßnahme beschrieben ist\n2. Eine Anforderung mit Level 5 ist immer entbehrlich, **außer** wenn sie durch in der beigefügten Risikoanalyse explizit gefordert wird. Eine Formulierung, dass diese Anforderung nicht von der Risikoanalyse gefordert wird, ist also für Anforderungen im Level 5 immer akzeptabel! Auch ist es akzeptabel, wenn für Level 5 keine Begründung für Entbehrlich vorhanden ist!\n\nFüge eine Liste der nicht ausreichenden begründeten Entbehrlichen Anforderungen mit begründung der Feststellung hinzu!",
        "muss_anforderungen": "Sind alle diese MUSS-Anforderungen (Level 1) mit Status 'Ja' umgesetzt? Füge eine Liste der nicht umgesetzten MUSS Anforderungen der Feststellung hinzu!",
        "nicht_umgesetzt": "Sind diese nicht oder teilweise umgesetzten Anforderungen im angehängten Realisierungsplan (A.6) dokumentiert? Füge eine kurze Auswahl der im A.6 enthaltenen nicht umgesetzten Anforderungen der Feststellung hinzu!"
      },
      "realisierungsplan": {
        "schema_path": "assets/schemas/generic_3_question_schema.json",
        "source_categories": ["Realisierungsplan"]
      },
      "ergebnisDerDokumentenpruefung": {
        "type": "summary",
        "schema_path": "assets/schemas/stage_3_9_ergebnis_schema.json"
      }
    },
    "Chapter-4": {
      "auswahlBausteineErstRezertifizierung": {
        "key": "4.1.1",
        "prompt": "You are a BSI Lead Auditor planning an initial certification audit (Erstzertifizierung). Your plan must strictly adhere to the rules outlined in the official BSI \"Auditierungsschema\".\n\n**CRITICAL INSTRUCTION:** Your plan MUST be based on the customer's actual system structure provided below in the 'System Structure Map'. When selecting a Zielobjekt, you MUST use the corresponding `name` and `kuerzel` from the `zielobjekte` list. The selected `kuerzel` MUST be one that the chosen Baustein is actually mapped to in the `baustein_to_zielobjekt_mapping`.\n\n**System Structure Map (Ground Truth):**\n---\n{ground_truth_map_json}\n---\n\n**Official Rules for Baustein Selection (from Auditierungsschema, Chapter 4.3):**\n1.  **Minimum Count:** You MUST audit at least 6 Bausteine.\n2.  **Mandatory Baustein:** The Baustein 'ISMS.1 Sicherheitsmanagement' MUST be included in your selection. Its Zielobjekt is ALWAYS 'Gesamter Informationsverbund' (Kürzel: 'Informationsverbund').\n3.  **Risk-Oriented Selection:** You must select the other Bausteine based on risk, ensuring that you cover a variety of layers (Schichten) like ORP, CON, OPS, NET, INF, and SYS.\n4.  **Justification:** You MUST provide a concise, professional justification ('Begründung zur Auswahl') for the selection of each Baustein. The justification must be a full sentence explaining the risk-based reason for the selection. Example: 'Überprüfung der zentralen Firewall-Regeln, da diese den gesamten Informationsverbund nach außen absichern.'\n\nBased on the ground-truth map and the official rules, generate a realistic, accurate, and compliant audit plan with the required columns 'Schicht', 'Baustein', 'Zielobjekt-Name', 'Zielobjekt-Kürzel', and 'Begründung zur Auswahl'.",
        "schema_path": "assets/schemas/stage_4_1_1_auswahl_bausteine_erst_schema.json"
      },
      "auswahlBausteine1Ueberwachungsaudit": {
        "key": "4.1.2",
        "prompt": "You are a BSI Lead Auditor planning the **first surveillance audit (1. Überwachungsaudit)**. Your plan must strictly adhere to the rules outlined in the official BSI \"Auditierungsschema\".\n\n**CRITICAL INSTRUCTION:** Your plan MUST be based on the customer's actual system structure provided below in the 'System Structure Map'. When selecting a Zielobjekt, you MUST use the corresponding `name` and `kuerzel` from the `zielobjekte` list. The selected `kuerzel` MUST be one that the chosen Baustein is actually mapped to in the `baustein_to_zielobjekt_mapping`.\n\n**System Structure Map (Ground Truth):**\n---\n{ground_truth_map_json}\n---\n\n**Official Rules for Baustein Selection for a Surveillance Audit:**\n1.  **Mandatory Baustein:** The Baustein 'ISMS.1 Sicherheitsmanagement' MUST be included. Its Zielobjekt is ALWAYS 'Gesamter Informationsverbund' (Kürzel: 'Informationsverbund').\n2.  **Minimum Count:** You MUST select at least **two** other Bausteine in addition to ISMS.1.\n3.  **Risk-Oriented Selection:** You must select the other Bausteine based on significant changes, previous deviations, or risk. Ensure you cover a variety of layers (Schichten) like ORP, CON, OPS, NET, INF, and SYS.\n4.  **Justification:** You must provide a concise, professional justification (Begründung zur Auswahl) for the selection of each Baustein.\n\nBased on the ground-truth map and the official rules, generate a realistic, accurate, and compliant audit plan with the required columns 'Schicht', 'Baustein', 'Zielobjekt-Name', 'Zielobjekt-Kürzel', and 'Begründung zur Auswahl'.",
        "schema_path": "assets/schemas/stage_4_1_2_auswahl_bausteine_ueberwachung_schema.json"
      },
        "auswahlBausteine2Ueberwachungsaudit": {
          "key": "4.1.3",
          "prompt": "You are a BSI Lead Auditor planning the **second surveillance audit (2. Überwachungsaudit)**. Your plan must strictly adhere to the rules outlined in the official BSI \"Auditierungsschema\".\n\n**CRITICAL INSTRUCTION:** Your plan MUST be based on the customer's actual system structure provided below in the 'System Structure Map'. When selecting a Zielobjekt, you MUST use the corresponding `name` and `kuerzel` from the `zielobjekte` list. The selected `kuerzel` MUST be one that the chosen Baustein is actually mapped to in the `baustein_to_zielobjekt_mapping`.\n\n**System Structure Map (Ground Truth):**\n---\n{ground_truth_map_json}\n---\n\n**Official Rules for Baustein Selection for a Surveillance Audit:**\n1.  **Mandatory Baustein:** The Baustein 'ISMS.1 Sicherheitsmanagement' MUST be included. Its Zielobjekt is ALWAYS 'Gesamter Informationsverbund' (Kürzel: 'Informationsverbund').\n2.  **Minimum Count:** You MUST select at least **two** other Bausteine in addition to ISMS.1.\n3.  **No Repeats (where possible):** The selected Bausteine (other than ISMS.1) should ideally be different from those chosen in the first surveillance audit to ensure broad coverage over the certification lifecycle.\n4.  **Risk-Oriented Selection:** You must select the other Bausteine based on significant changes, previous deviations, or risk. Ensure you cover a variety of layers (Schichten) like ORP, CON, OPS, NET, INF, and SYS.\n5.  **Justification:** You must provide a concise, professional justification (Begründung zur Auswahl) for the selection of each Baustein.\n\nBased on the ground-truth map and the official rules, generate a realistic, accurate, and compliant audit plan with the required columns 'Schicht', 'Baustein', 'Zielobjekt-Name', 'Zielobjekt-Kürzel', and 'Begründung zur Auswahl'.",
          
          "schema_path": "assets/schemas/stage_4_1_3_auswahl_bausteine_ueberwachung_schema.json"
      },
      "auswahlMassnahmenAusRisikoanalyse": {
        "key": "4.1.5",
        "prompt": "You are a BSI Lead Auditor planning an audit. Based on the attached Risikoanalyse document, representative sample of 6 additional security measures that were identified for assets with \"high\" or \"very high\" protection needs. Make sure you find the correct Zielobjekt. These are measures BEYOND the standard IT-Grundschutz baseline requirements.\n\nIf the Risikoanalyse document is not available or doesn't contain specific additional measures, generate plausible examples based on typical high-protection scenarios.\n\nFor each selected measure, provide a plausible and risk-oriented justification (key: 'Begründung zur Auswahl') for its inclusion in the on-site audit plan.\n\nExamples of good justifications:\n- \"To verify the effectiveness of the advanced DDoS mitigation for the public-facing web application, which is a critical business process.\"\n- \"To check the implementation of database encryption, as this measure was identified to protect highly sensitive customer PII.\"\n- \"To confirm the sandboxing of the email attachment analysis system, a key control against advanced persistent threats.\"",
        "schema_path": "assets/schemas/stage_4_1_5_auswahl_massnahmen_risiko_schema.json",
        "source_categories": ["Risikoanalyse"]
      }
    },
    "Scan-Report": {
      "extract_chapter_1": {
        "prompt": "You are an expert data extraction system. From the attached previous audit report, extract the complete content of the tables in subchapters 1.1 (Versionshistorie), 1.2 (Kontaktinformationen des Antragstellers AND Ansprechpartner), and 1.3 (Auditteam). The auditteam has multiple sub-tables; capture all of them.",
        "schema_path": "assets/schemas/scan_report_ch1_schema.json"
      },
      "extract_chapter_4": {
        "prompt": "You are an expert data extraction system. From the attached previous audit report, extract the 'Auswahl Bausteine' tables from subchapters 4.1.1 and 4.1.2, and the 'Auswahl Standorte' table from 4.1.4. Capture all rows from all three tables.",
        "schema_path": "assets/schemas/scan_report_ch4_schema.json"
      },
      "extract_chapter_7": {
        "prompt": "From the attached audit report, find chapter 7.2 'Abweichungen und Empfehlungen'. Scan this chapter and its sub-chapters for any tables containing findings. These tables might be titled 'Abweichungen', 'Schwerwiegende Abweichungen', 'Geringfügige Abweichungen', or 'Empfehlungen'. Extract every single finding you can identify into a single, flat list. For each finding, determine its category ('AS' for Schwerwiegend, 'AG' for Geringfügig, or 'E' for Empfehlung) and extract all its corresponding table columns like 'Nummer', 'Beschreibung', 'Quelle', 'Behebungsfrist', and 'Status'.",
        "schema_path": "assets/schemas/scan_report_ch7_schema.json"
      }
    }
  }
}